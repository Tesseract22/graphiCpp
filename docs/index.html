<!DOCTYPE html>

<head>
    <script>
        const env = {
            undefined: () => { console.log("env"); },
            sinp: Math.sin,
            cosp: Math.cos,
            tanp: Math.tan,
            pi: Math.PI,
            sqrtp: Math.sqrt
        };
        const imported = {}
        imported["env"] = new Proxy(env, {
            get: function (obj, prop) {
                return prop in env ? env[prop] : () => { console.error("UNIMPLEMENTED: " + prop); return undefined; };
            }
        })
        async function loadModule(url = "index.wasm") {
            const module = await WebAssembly.instantiateStreaming(
                fetch(url), imported
            );
            return module;
        }
        function sleep(time) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve();
                }, time);
            });
        }

        async function loadDemo(module, id, entry = (exports, t) => { exports.main(t); }, update = (exports, t) => { exports.main(t) }, playable = false, drawable = false) {



            const exports = module.instance.exports;
            const memory = exports.memory.buffer;

            const H = exports.HEIGHT();
            const W = exports.WIDTH();
            console.log(H, W);
            const cv = new ImageData(new Uint8ClampedArray(memory, exports["cv"], H * W * 4), W);

            entry(exports);
            console.log(cv)
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext("2d");
            canvas.width = W;
            canvas.height = H;
            ctx.putImageData(cv, 0, 0);
            if (playable) {
                let t = 0;
                let play = false;

                canvas.onmouseover = async (ev) => {
                    console.log(t)
                    play = true
                    while (play) {
                        update(exports, t++ * 100);
                        ctx.putImageData(cv, 0, 0)
                        await sleep(10)
                    }

                }
                canvas.ontouchstart = async (ev) => {
                    ev.preventDefault();

                    play = !play
                    while (play) {
                        entry(exports, t++ * 100);
                        ctx.putImageData(cv, 0, 0)
                        await sleep(10)
                    }

                }
                canvas.onmouseleave = () => { play = false; }
                canvas.ontouchend = () => { play = false; }
            }

            if (drawable) {
                canvas.onmousedown = (downEv) => {
                    canvas.onmousemove = (moveEv) => {
                        console.log(moveEv.offsetX, moveEv.offsetY);
                        update(exports, moveEv.offsetX, moveEv.offsetY);
                        ctx.putImageData(cv, 0, 0);

                    }
                }
                canvas.onmouseup = (ev) => {
                    canvas.onmousemove = () => { };
                };

            }





        };
        const defaultPlay = (exports, t) => { exports.render(t); }
        const noOp = () => { };
        loadModule("basic.wasm").then((module) => {
            console.log(module)
            loadDemo(module, "basic")
        })
        loadModule("color.wasm").then((module) => {
            loadDemo(module, "color")
        })

        loadModule("3d.wasm").then((module) => {
            loadDemo(module, "3d", defaultPlay, defaultPlay, true);
        })
        loadModule("cube.wasm").then((module) => {
            loadDemo(module, "cube", defaultPlay, defaultPlay, true);
        })
        loadModule("triangle.wasm").then((module) => {
            loadDemo(module, "triangle", defaultPlay, defaultPlay, true);
        })
        loadModule("draw.wasm").then((module) => {
            loadDemo(module, "draw", (exports, t) => (exports.init()), (exports, x, y) => { exports.draw(x, y); }, false, true);
        })


    </script>

</head>

<body>
    <canvas id="basic"></canvas>
    <canvas id="color"></canvas>
    <div>touch or hover to play</div>
    <canvas id="3d"></canvas>
    <div>touch or hover to play</div>
    <canvas id="cube"></canvas>
    <canvas id="triangle"></canvas>
    <canvas id="draw"></canvas>
</body>