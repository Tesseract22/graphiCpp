<!DOCTYPE html>
<script>
    const env = {
        undefined: () => { console.log("env"); },
        sinp: Math.sin,
        cosp: Math.cos,
        tanp: Math.tan,
        pi: Math.PI,
        sqrtp: Math.SQRT2
    };
    const imported = {}
    imported["env"] = new Proxy(env, {
        get: function (obj, prop) {
            return prop in env ? env[prop] : () => { console.error("UNIMPLEMENTED: " + prop); return undefined; };
        }
    })
    async function loadModule(url = "index.wasm") {
        const module = await WebAssembly.instantiateStreaming(
            fetch(url), imported
        );
        return module;
    }


    async function loadDemo(module, id) {



        const exports = module.instance.exports;
        const memory = exports.memory.buffer;

        const H = exports.HEIGHT();
        const W = exports.WIDTH();
        console.log(H, W);
        const cv = new ImageData(new Uint8ClampedArray(memory, exports["cv"], H * W * 4), W);

        exports.main();
        console.log(cv)
        const canvas = document.getElementById(id);
        const ctx = canvas.getContext("2d");
        canvas.width = W;
        canvas.height = H;
        ctx.putImageData(cv, 0, 0);
    };
    loadModule("basic.wasm").then((module) => {
        console.log(module)
        loadDemo(module, "basic")
    })
    loadModule("color.wasm").then((module) => {
        loadDemo(module, "color")
    })

    loadModule("3d.wasm").then((module) => {
        loadDemo(module, "3d")
    })


</script>
<canvas id="basic"></canvas>
<canvas id="color"></canvas>
<canvas id="3d"></canvas>